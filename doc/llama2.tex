\documentclass[letterpaper,12pt]{article}
\usepackage{times}
\usepackage{helvet}
\usepackage{courier}
\usepackage{fancyheadings}
\usepackage{hyperref}
\usepackage{xcolor}
\pagestyle{fancy}
\usepackage{graphicx}
\usepackage{verbatim}
\setlength\textwidth{6.5in}
\setlength\textheight{8.5in}
\newcommand{\TBC}{\framebox{\textbf{TO BE COMPLETED}}}
\newtheorem{assumption}{Assumption}
\newcommand{\be}{\begin{enumerate}}
\newcommand{\ee}{\end{enumerate}}
\newcommand{\bi}{\begin{itemize}}
\newcommand{\ei}{\end{itemize}}
\newcommand{\bd}{\begin{description}}
\newcommand{\ed}{\end{description}}
\newtheorem{notation}{Notation}
\begin{document}
\title{Karpathy Inference for Llama-2}
\author{Ramesh Subramonian }
\maketitle
\thispagestyle{fancy}
\lhead{}
\chead{}
\rhead{}
% \lfoot{{\small Decision Sciences Team}}
\cfoot{}
\rfoot{{\small \thepage}}

\begin{abstract}

\ Step-by-step re-implementation of Karpathy code for llama2.

\end{abstract}

\section{XXX}
\subsection{Conventions}

If \(T\) is a table of dimensions \(n_1 \times n_2\),
then \(T_i\) is a vector of length \(n_2\)

\subsection{Glossary}

  \begin{table}[hbtp]
    \centering
    \begin{tabular}{|l||l|l|l|} \hline \hline
      {\bf Abbreviation} & {\bf C code} &  {\bf Comments} \\ \hline
      \(n_D\) & {\tt dim} & \\ \hline
      \(n_{HD}\) & {\tt hidden\_dim} & \\ \hline
      \(n_{KVD}\) & {\tt n\_kv\_dim} & \(n_D \times n_{KVH} / n_H\) \\ \hline
      \(n_L\) & {\tt n\_layers} & \\ \hline
      \(n_H\) & {\tt n\_heads} & \\ \hline
      \(n_{KVH}\) & {\tt n\_kv\_heads} & \\ \hline

      \(n_V\) & {\tt vocab\_size} & \\ \hline
      \(n_S\) & {\tt seq\_len} & \\ \hline
      \(s_H\) & {\tt head\_size} & \\ \hline
      \hline
      \(n_D'\) & {\tt ispc\_dim} & \\ \hline
      \hline
    \end{tabular}
      \caption{Scalars: Mapping math notation to C code} 
      \label{sclr_math_notation}
  \end{table}
%       \(S_{kc}\) & key\_cache &  \\ \hline 
%       \(S_{vc}\) & value\_cache & \\ \hline 

\begin{table}[hbtp]
\centering
\begin{tabular}{|l||l|l|l|l|l|} \hline \hline
  {\bf Purpose} &   {\bf Abbreviation} & {\bf C code} & {\bf Dim1}  & {\bf Dim2} & {\bf Dim3} \\ \hline 
\hline
  & \(x\) & x & \(n_D\) & & \\ \hline
  & \(xb\) & xb & \(n_D\) & & \\ \hline
  & \(xb2\) & xb2 & \(n_D\) & & \\ \hline
  & \(xhb\) & xhb & \(n_{HD}\) & & \\ \hline
  & \(xhb2\) & xhb2 & \(n_{HD}\) & & \\ \hline
  & \(q\) & q & \(n_H\) & \(s_H\) & \\ \hline
  & \(kc\) & key\_cache & \(n_L\) & \(n_S\) & \(n_{KVD}\)\\ \hline
  & \(vc\) & val\_cache & \(n_L\) & \(n_S\) & \(n_{KVD}\)\\ \hline
  & \(att\) & att & \(n_H\) & \(n_S\) &  \\ \hline
  & \(logits\) & logits & \(n_V\) & & \\ \hline
\hline
\end{tabular}
\caption{State: Mapping math notation to C code} 
\label{state_math_notation}
\end{table}

\begin{table}[hbtp]
\centering
\begin{tabular}{|l||l|l|l|l|l|} \hline \hline
  {\bf Purpose} &   {\bf Abbreviation} & {\bf C code} & {\bf Dim1}  & {\bf Dim2} & {\bf Dim3} \\ \hline 
\hline
Token Embedding  & \(W_t\) & token embedding table & \(n_V\) & \(n_D\) & \\ \hline
  \hline
  Normalization & \(W_{att}\) & rms\_att\_weight & \(n_L\) & \(n_D \) & \\ \hline
  Normalization & \(W_{ffn}\) & rms\_ffn\_weight & \(n_L\) & \(n_D \) & \\ \hline
  \hline
  XXX &  \(W_{fin}\) & rms\_final\_weight & \(n_D \) & & \\ \hline
  \hline
  Attention &  \(W_q\) & w\_q & \(n_L\) &  \(n_D\) & \(n_H \times s_H\) \\ \hline
  Attention & \(W_k\) & w\_k & \(n_L\) & \(n_D\) & \(n_{KVH} \times s_H\) \\ \hline
  Attention & \(W_v\) & w\_v & \(n_L\) & \(n_D\) & \(n_{KVH} \times s_H\) \\ \hline
  Attention & \(W_o\) & w\_o & \(n_L\) & \(n_H \times s_H\) & \(n_D\) \\ \hline
\hline
\end{tabular}
\caption{Weights: Mapping math notation to C code} 
\label{weights_math_notation}
\end{table}

\clearpage
\section{Utilities}

  \clearpage
  \section{Forward}
Arguments in Table~\ref{args_forward}
  \begin{table}[hbtp]
    \centering
    \begin{tabular}{|l||l|l|} \hline \hline
      {\bf Argument} & {\bf Type} & {\bf Comments}  \\ \hline 
      \(T\) & {\tt Transformer} & pointer \\ \hline 
      \(t\) & integer & token \(0 \leq t < n_V\) \\ \hline
      \(p\) & integer & pos \\ \hline
      \hline 
      {\bf Argument} & {\bf Type} & {\bf Comments}  \\ \hline 
      \(d\) & integer & dim \\ 
    \hline
    \end{tabular}
      \caption{Arguments/Convenience Variables for forward}
      \label{args_forward}
  \end{table}

\newcommand{\D}{\mathrm{dim}}
\newcommand{\KD}{\mathrm{kv\_dim}}


Copy token into \(x\), Equation~\ref{eqn_token}
\begin{equation}
  \label{eqn_token}
  x \leftarrow W_t[t][\ldots]
\end{equation}

Repeat following steps for each layer, \(l\)

\be
\item 
attention rmsnorm,  Equation~\ref{eqn_att_rmsnorm}
 \begin{equation}
   \label{eqn_att_rmsnorm}
xb \leftarrow {\mathrm rmsnorm}(x, W_{ra}[l]
 \end{equation}

\item  qkv matmuls for this position, 
 Equations~\ref{eqn_xx}, ~\ref{eqn_yy}, ~\ref{eqn_zz}.
 \begin{equation}
   \label{eqn_xx}
   S_{wq}[l][d] \leftarrow {\mathrm matmul}(xb, W_{wq}[l], n_D, n_D)
 \end{equation}

 \begin{equation}
   \label{eqn_yy}
   S_{kc}[l][p] \leftarrow {\mathrm matmul}(xb, W_{wk}[l], n_D, n_{KVD})
 \end{equation}

 \begin{equation}
   \label{eqn_zz}
S_{vc}[l][p] \leftarrow {\mathrm matmul}(xb, W_{wv}[l], n_D, n_{KVD})
 \end{equation}

 \item residual connection back into x, Equation~\ref{eqn_residual}
   \begin{equation}
     \label{eqn_residual}
x \leftarrow x + xb2
   \end{equation}

 \ee
  \clearpage
\subsection{rmsnorm}
\label{rmsnorm}

Input is in Table~\ref{args_rmsnorm}. Output is \(o\), {\tt float} vector of length \(n\) 
  \begin{table}[hbtp]
    \centering
    \begin{tabular}{|l||l|l|} \hline \hline
      {\bf Argument} & {\bf Type}  \\ \hline 
      \(x\) & {\tt float} vector of length \(n\) \\ \hline
      \(w\) & {\tt float} vector of length \(n\) \\ \hline
    \hline
    \end{tabular}
      \caption{Arguments for rmsnorm}
      \label{args_rmsnorm}
  \end{table}

  \be
\item \(\alpha = ((\sum_i {x_i}^2)/n)+\epsilon\)
\item \(o_i \leftarrow \frac{ w_i \times x_i}{\alpha}\)
  \ee

  \clearpage
\subsection{softmax}
\label{softmax}

Arguments in Table~\ref{args_softmax}
  \begin{table}[hbtp]
    \centering
    \begin{tabular}{|l||l|l|} \hline \hline
      {\bf Argument} & {\bf Type}  \\ \hline 
      \(x\) & {\tt float} vector of length \(n\) \\ \hline
      \(n\) & integer \\ \hline
    \hline
    \end{tabular}
      \caption{Arguments for softmax}

      \label{args_softmax}
  \end{table}

  \be
\item \(m = {\mathrm max}_{i=0}^{i=n-1} x_i\)
\item \(\forall_{i=0}^{i=n-1} x_i \leftarrow e^{x_i - m}\)
\item \(s = \sum_{i=0}^{i=n-1} x_i\)
\item \(\forall_{i=0}^{i=n-1} x_i \leftarrow \frac{x_i}{s}\)
  \ee

\end{document}

